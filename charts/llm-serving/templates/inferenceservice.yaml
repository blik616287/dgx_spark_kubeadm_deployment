{{- if .Values.kserve }}
{{- range $name, $model := .Values.models }}
{{- if $model.enabled }}
---
apiVersion: "serving.kserve.io/v1beta1"
kind: "InferenceService"
metadata:
  name: {{ $name }}
  namespace: {{ $.Values.namespace }}
  annotations:
    serving.kserve.io/deploymentMode: RawDeployment
spec:
  predictor:
    {{- with $.Values.nodeSelector }}
    nodeSelector:
      {{- toYaml . | nindent 6 }}
    {{- end }}
    runtimeClassName: nvidia
    containers:
      - name: kserve-container
        image: {{ $model.image }}
        ports:
          - containerPort: {{ $model.port }}
            name: http
            protocol: TCP
        env:
          - name: OLLAMA_HOST
            value: "0.0.0.0:{{ $model.port }}"
          - name: OLLAMA_NUM_PARALLEL
            value: {{ $model.numParallel | quote }}
          - name: OLLAMA_MODELS
            value: /root/.ollama
          - name: OLLAMA_KEEP_ALIVE
            value: "-1"
          - name: OLLAMA_FLASH_ATTENTION
            value: "1"
          {{- if $model.numCtx }}
          - name: OLLAMA_CONTEXT_LENGTH
            value: {{ $model.numCtx | quote }}
          {{- end }}
        resources:
          {{- toYaml $model.resources | nindent 10 }}
        volumeMounts:
          - name: ollama-data
            mountPath: /root/.ollama
          {{- if $model.toolsModelfile }}
          - name: modelfiles
            mountPath: /modelfiles
            readOnly: true
          {{- end }}
        lifecycle:
          postStart:
            exec:
              command:
                - /bin/sh
                - -c
                - |
                  until ollama list >/dev/null 2>&1; do sleep 1; done
                  ollama show {{ $model.ollamaPull }} >/dev/null 2>&1 || ollama pull {{ $model.ollamaPull }}
                  {{- if and $model.toolsAlias $model.toolsModelfile }}
                  ollama show {{ $model.toolsAlias }} >/dev/null 2>&1 || ollama create {{ $model.toolsAlias }} -f /modelfiles/{{ $model.toolsModelfile }}
                  {{- end }}
    volumes:
      - name: ollama-data
        hostPath:
          path: {{ $.Values.ollamaDataHostPath }}/{{ $name }}
          type: DirectoryOrCreate
      {{- if $model.toolsModelfile }}
      - name: modelfiles
        configMap:
          name: ollama-modelfiles
      {{- end }}
{{- end }}
{{- end }}
{{- end }}
